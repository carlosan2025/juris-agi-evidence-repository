# Evidence Repository - Docker Compose Configuration
# Local development setup with API, Worker, Redis, and PostgreSQL + pgvector

services:
  # ==========================================================================
  # API Service
  # ==========================================================================
  api:
    build:
      context: .
      dockerfile: Dockerfile
    container_name: evidence-api
    ports:
      - "8000:8000"
    environment:
      # Application
      - APP_NAME=Evidence Repository
      - DEBUG=true
      - LOG_LEVEL=DEBUG

      # Database
      - DATABASE_URL=postgresql+asyncpg://evidence:evidence_secret@postgres:5432/evidence_repository

      # Redis
      - REDIS_URL=redis://redis:6379/0
      - REDIS_QUEUE_NAME=evidence_jobs

      # Storage
      - STORAGE_BACKEND=local
      - FILE_STORAGE_ROOT=/app/data/files

      # Auth (development keys)
      - API_KEYS=dev-key-12345,test-key-67890

      # LovePDF (set in .env for actual keys)
      - LOVEPDF_PUBLIC_KEY=${LOVEPDF_PUBLIC_KEY:-}
      - LOVEPDF_SECRET_KEY=${LOVEPDF_SECRET_KEY:-}

      # OpenAI (set in .env for actual key)
      - OPENAI_API_KEY=${OPENAI_API_KEY:-}
      - OPENAI_EMBEDDING_MODEL=text-embedding-3-small
      - OPENAI_EMBEDDING_DIMENSIONS=1536

      # CORS (allow local frontend development)
      - CORS_ORIGINS=["http://localhost:3000","http://localhost:8080"]
    volumes:
      # Mount local storage directory
      - ./data:/app/data
      # Mount source for development (hot reload)
      - ./src:/app/src:ro
    depends_on:
      postgres:
        condition: service_healthy
      redis:
        condition: service_healthy
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8000/api/v1/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 10s
    networks:
      - evidence-network
    restart: unless-stopped

  # ==========================================================================
  # Worker Service (Background Job Processing)
  # ==========================================================================
  worker:
    build:
      context: .
      dockerfile: Dockerfile
    container_name: evidence-worker
    command: ["python", "-m", "evidence_repository.worker"]
    environment:
      # Application
      - APP_NAME=Evidence Repository Worker
      - DEBUG=true
      - LOG_LEVEL=INFO

      # Database (sync URL for worker)
      - DATABASE_URL=postgresql+asyncpg://evidence:evidence_secret@postgres:5432/evidence_repository

      # Redis
      - REDIS_URL=redis://redis:6379/0
      - REDIS_QUEUE_NAME=evidence_jobs

      # Storage
      - STORAGE_BACKEND=local
      - FILE_STORAGE_ROOT=/app/data/files

      # OpenAI (for embedding generation)
      - OPENAI_API_KEY=${OPENAI_API_KEY:-}
      - OPENAI_EMBEDDING_MODEL=text-embedding-3-small
      - OPENAI_EMBEDDING_DIMENSIONS=1536

      # LovePDF (for PDF extraction)
      - LOVEPDF_PUBLIC_KEY=${LOVEPDF_PUBLIC_KEY:-}
      - LOVEPDF_SECRET_KEY=${LOVEPDF_SECRET_KEY:-}
    volumes:
      # Shared storage with API
      - ./data:/app/data
      # Mount source for development
      - ./src:/app/src:ro
    depends_on:
      postgres:
        condition: service_healthy
      redis:
        condition: service_healthy
      migrations:
        condition: service_completed_successfully
    networks:
      - evidence-network
    restart: unless-stopped
    deploy:
      replicas: 1  # Scale up for more processing capacity

  # ==========================================================================
  # Redis (Job Queue)
  # ==========================================================================
  redis:
    image: redis:7-alpine
    container_name: evidence-redis
    ports:
      - "6379:6379"
    volumes:
      - redis_data:/data
    command: redis-server --appendonly yes
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 10s
      timeout: 5s
      retries: 5
    networks:
      - evidence-network
    restart: unless-stopped

  # ==========================================================================
  # PostgreSQL with pgvector
  # ==========================================================================
  postgres:
    image: pgvector/pgvector:pg16
    container_name: evidence-postgres
    ports:
      - "5432:5432"
    environment:
      - POSTGRES_USER=evidence
      - POSTGRES_PASSWORD=evidence_secret
      - POSTGRES_DB=evidence_repository
    volumes:
      # Persist database data
      - postgres_data:/var/lib/postgresql/data
      # Initialization scripts
      - ./scripts/init-db.sql:/docker-entrypoint-initdb.d/init-db.sql:ro
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U evidence -d evidence_repository"]
      interval: 10s
      timeout: 5s
      retries: 5
    networks:
      - evidence-network
    restart: unless-stopped

  # ==========================================================================
  # Database Migrations (run once)
  # ==========================================================================
  migrations:
    build:
      context: .
      dockerfile: Dockerfile
    container_name: evidence-migrations
    command: ["alembic", "upgrade", "head"]
    environment:
      - DATABASE_URL=postgresql+asyncpg://evidence:evidence_secret@postgres:5432/evidence_repository
    depends_on:
      postgres:
        condition: service_healthy
    networks:
      - evidence-network
    restart: "no"

  # ==========================================================================
  # RQ Dashboard (Optional - for monitoring jobs)
  # ==========================================================================
  rq-dashboard:
    image: eoranged/rq-dashboard:latest
    container_name: evidence-rq-dashboard
    ports:
      - "9181:9181"
    environment:
      - RQ_DASHBOARD_REDIS_URL=redis://redis:6379/0
    depends_on:
      redis:
        condition: service_healthy
    networks:
      - evidence-network
    restart: unless-stopped
    profiles:
      - monitoring  # Only starts with: docker-compose --profile monitoring up

# =============================================================================
# Networks
# =============================================================================
networks:
  evidence-network:
    driver: bridge

# =============================================================================
# Volumes
# =============================================================================
volumes:
  postgres_data:
    driver: local
  redis_data:
    driver: local
